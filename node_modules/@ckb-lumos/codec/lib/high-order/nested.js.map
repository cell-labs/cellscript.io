{"version":3,"file":"nested.js","names":["createNullableCodec","codec","pack","packable","trackCodeExecuteError","CODEC_OPTIONAL_PATH","unpack","unpackable","createObjectCodec","codecShape","codecEntries","Object","entries","packableObj","result","forEach","key","itemCodec","assign","unpackableObj","createArrayCodec","items","map","item","index","enhancePack","afterCodecPack","beforeCodecUnpack"],"sources":["../../src/high-order/nested.ts"],"sourcesContent":["import {\n  AnyCodec,\n  Codec,\n  PackParam,\n  PackResult,\n  UnpackParam,\n  UnpackResult,\n} from \"../base\";\nimport { trackCodeExecuteError } from \"../utils\";\nimport { CODEC_OPTIONAL_PATH } from \"../error\";\n\nexport interface NullableCodec<C extends AnyCodec = AnyCodec> extends AnyCodec {\n  pack(packable?: PackParam<C>): PackResult<C>;\n\n  unpack(unpackable?: UnpackParam<C>): UnpackResult<C>;\n}\n\nexport function createNullableCodec<C extends AnyCodec = AnyCodec>(\n  codec: C\n): NullableCodec<C> {\n  return {\n    pack: (packable) => {\n      if (packable == null) return packable;\n      return trackCodeExecuteError(CODEC_OPTIONAL_PATH, () =>\n        codec.pack(packable)\n      );\n    },\n    unpack: (unpackable) => {\n      if (unpackable == null) return unpackable;\n      return codec.unpack(unpackable);\n    },\n  };\n}\n\ntype ObjectCodecShape = Record<string, AnyCodec>;\nexport type ObjectCodec<Shape extends ObjectCodecShape = ObjectCodecShape> =\n  Codec<\n    { [key in keyof Shape]: PackResult<Shape[key]> },\n    { [key in keyof Shape]: UnpackResult<Shape[key]> },\n    { [key in keyof Shape]: PackParam<Shape[key]> },\n    { [key in keyof Shape]: UnpackParam<Shape[key]> }\n  >;\n\n/**\n * a high-order codec that helps to organize multiple codecs together into a single object\n * @param codecShape\n * @example\n * ```ts\n * const codec = createObjectCodec({\n *   r: Uint8,\n *   g: Uint8,\n *   b: Uint8,\n * });\n *\n * // { r: ArrayBuffer([0xff]), g: ArrayBuffer([0x00]), b: ArrayBuffer([0x00]) }\n * codec.pack({ r: 255, g: 0, b: 0 });\n * ```\n */\nexport function createObjectCodec<Shape extends ObjectCodecShape>(\n  codecShape: Shape\n): ObjectCodec<Shape> {\n  const codecEntries = Object.entries(codecShape);\n\n  return {\n    pack: (packableObj) => {\n      const result = {} as { [key in keyof Shape]: PackResult<Shape[key]> };\n\n      codecEntries.forEach(([key, itemCodec]) => {\n        Object.assign(result, {\n          [key]: trackCodeExecuteError(key, () =>\n            itemCodec.pack(packableObj[key])\n          ),\n        });\n      });\n\n      return result;\n    },\n    unpack: (unpackableObj) => {\n      const result = {} as { [key in keyof Shape]: UnpackResult<Shape[key]> };\n\n      codecEntries.forEach(([key, itemCodec]) => {\n        Object.assign(result, { [key]: itemCodec.unpack(unpackableObj[key]) });\n      });\n\n      return result;\n    },\n  };\n}\n\nexport type ArrayCodec<C extends AnyCodec> = Codec<\n  PackResult<C>[],\n  UnpackResult<C>[],\n  PackParam<C>[],\n  UnpackParam<C>[]\n>;\n\nexport function createArrayCodec<C extends AnyCodec>(codec: C): ArrayCodec<C> {\n  return {\n    pack: (items) =>\n      items.map((item, index) =>\n        trackCodeExecuteError(index, () => codec.pack(item))\n      ),\n    unpack: (items) => items.map((item) => codec.unpack(item)),\n  };\n}\n\n/**\n * @param codec\n * @param afterCodecPack\n * @param beforeCodecUnpack\n */\nexport function enhancePack<C extends AnyCodec, Packed>(\n  codec: C,\n  afterCodecPack: (arg: PackResult<C>) => Packed,\n  beforeCodecUnpack: (arg: Packed) => UnpackParam<C>\n): Codec<Packed, UnpackResult<C>, PackParam<C>> {\n  return {\n    pack: (packable) => afterCodecPack(codec.pack(packable)),\n    unpack: (unpackable) => codec.unpack(beforeCodecUnpack(unpackable)),\n  };\n}\n"],"mappings":";;;;;;;;;;AAQA;;AACA;;AAQO,SAASA,mBAAT,CACLC,KADK,EAEa;EAClB,OAAO;IACLC,IAAI,EAAGC,QAAD,IAAc;MAClB,IAAIA,QAAQ,IAAI,IAAhB,EAAsB,OAAOA,QAAP;MACtB,OAAO,IAAAC,4BAAA,EAAsBC,0BAAtB,EAA2C,MAChDJ,KAAK,CAACC,IAAN,CAAWC,QAAX,CADK,CAAP;IAGD,CANI;IAOLG,MAAM,EAAGC,UAAD,IAAgB;MACtB,IAAIA,UAAU,IAAI,IAAlB,EAAwB,OAAOA,UAAP;MACxB,OAAON,KAAK,CAACK,MAAN,CAAaC,UAAb,CAAP;IACD;EAVI,CAAP;AAYD;;AAWD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASC,iBAAT,CACLC,UADK,EAEe;EACpB,MAAMC,YAAY,GAAGC,MAAM,CAACC,OAAP,CAAeH,UAAf,CAArB;EAEA,OAAO;IACLP,IAAI,EAAGW,WAAD,IAAiB;MACrB,MAAMC,MAAM,GAAG,EAAf;MAEAJ,YAAY,CAACK,OAAb,CAAqB,CAAC,CAACC,GAAD,EAAMC,SAAN,CAAD,KAAsB;QACzCN,MAAM,CAACO,MAAP,CAAcJ,MAAd,EAAsB;UACpB,CAACE,GAAD,GAAO,IAAAZ,4BAAA,EAAsBY,GAAtB,EAA2B,MAChCC,SAAS,CAACf,IAAV,CAAeW,WAAW,CAACG,GAAD,CAA1B,CADK;QADa,CAAtB;MAKD,CAND;MAQA,OAAOF,MAAP;IACD,CAbI;IAcLR,MAAM,EAAGa,aAAD,IAAmB;MACzB,MAAML,MAAM,GAAG,EAAf;MAEAJ,YAAY,CAACK,OAAb,CAAqB,CAAC,CAACC,GAAD,EAAMC,SAAN,CAAD,KAAsB;QACzCN,MAAM,CAACO,MAAP,CAAcJ,MAAd,EAAsB;UAAE,CAACE,GAAD,GAAOC,SAAS,CAACX,MAAV,CAAiBa,aAAa,CAACH,GAAD,CAA9B;QAAT,CAAtB;MACD,CAFD;MAIA,OAAOF,MAAP;IACD;EAtBI,CAAP;AAwBD;;AASM,SAASM,gBAAT,CAA8CnB,KAA9C,EAAuE;EAC5E,OAAO;IACLC,IAAI,EAAGmB,KAAD,IACJA,KAAK,CAACC,GAAN,CAAU,CAACC,IAAD,EAAOC,KAAP,KACR,IAAApB,4BAAA,EAAsBoB,KAAtB,EAA6B,MAAMvB,KAAK,CAACC,IAAN,CAAWqB,IAAX,CAAnC,CADF,CAFG;IAKLjB,MAAM,EAAGe,KAAD,IAAWA,KAAK,CAACC,GAAN,CAAWC,IAAD,IAAUtB,KAAK,CAACK,MAAN,CAAaiB,IAAb,CAApB;EALd,CAAP;AAOD;AAED;AACA;AACA;AACA;AACA;;;AACO,SAASE,WAAT,CACLxB,KADK,EAELyB,cAFK,EAGLC,iBAHK,EAIyC;EAC9C,OAAO;IACLzB,IAAI,EAAGC,QAAD,IAAcuB,cAAc,CAACzB,KAAK,CAACC,IAAN,CAAWC,QAAX,CAAD,CAD7B;IAELG,MAAM,EAAGC,UAAD,IAAgBN,KAAK,CAACK,MAAN,CAAaqB,iBAAiB,CAACpB,UAAD,CAA9B;EAFnB,CAAP;AAID"}