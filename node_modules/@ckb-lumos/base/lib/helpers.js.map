{"version":3,"file":"helpers.js","names":["isScriptWrapper","maybeWrapped","script","undefined","isCellMatchQueryOptions","cell","lock","type","argsLen","data","fromBlock","toBlock","wrappedLock","wrappedType","ScriptValue","cellOutput","validate","equals","cellLock","codeHash","hashType","args","startsWith","length","lockArgsLength","minLength","Math","min","slice","blockNumber","BI","from","lt","gt"],"sources":["../src/helpers.ts"],"sourcesContent":["import { ScriptValue } from \"./values\";\nimport { BI } from \"@ckb-lumos/bi\";\n\nimport { Cell, Script } from \"./api\";\nimport { QueryOptions, ScriptWrapper } from \"./indexer\";\n\n/**\n * return if the input is a script wrapper\n * @param maybeWrapped\n */\nexport function isScriptWrapper(\n  maybeWrapped: Script | ScriptWrapper | null\n): maybeWrapped is ScriptWrapper {\n  return (\n    maybeWrapped !== null &&\n    (maybeWrapped as ScriptWrapper).script !== undefined\n  );\n}\n\nexport function isCellMatchQueryOptions(\n  cell: Cell,\n  {\n    lock = undefined,\n    type = undefined,\n    argsLen = -1,\n    data = \"any\",\n    fromBlock = undefined,\n    toBlock = undefined,\n  }: QueryOptions\n): boolean {\n  let wrappedLock: ScriptWrapper | null = null;\n  let wrappedType: \"empty\" | ScriptWrapper | Script | null = null;\n\n  // Wrap the plain `Script` into `ScriptWrapper`.\n  if (lock && !isScriptWrapper(lock)) {\n    wrappedLock = { script: lock, argsLen: argsLen };\n  } else if (lock) {\n    wrappedLock = lock;\n    // check argsLen\n    if (!lock.argsLen) {\n      wrappedLock.argsLen = argsLen;\n    }\n  }\n  if (type && type === \"empty\") {\n    wrappedType = type;\n  } else if (type && typeof type === \"object\" && !isScriptWrapper(type)) {\n    wrappedType = { script: type, argsLen: argsLen };\n  } else if (type && typeof type === \"object\" && isScriptWrapper(type)) {\n    wrappedType = type;\n    // check argsLen\n    if (!type.argsLen) {\n      wrappedType.argsLen = argsLen;\n    }\n  }\n\n  if (wrappedLock && wrappedLock.script && wrappedLock.argsLen === -1) {\n    if (\n      !new ScriptValue(cell.cellOutput.lock, {\n        validate: false,\n      }).equals(new ScriptValue(wrappedLock.script, { validate: false }))\n    ) {\n      return false;\n    }\n  }\n\n  if (wrappedLock && wrappedLock.script && wrappedLock.argsLen === \"any\") {\n    const cellLock = cell.cellOutput.lock;\n    if (\n      cellLock.codeHash !== wrappedLock.script.codeHash ||\n      cellLock.hashType !== wrappedLock.script.hashType ||\n      !cellLock.args.startsWith(wrappedLock.script.args)\n    ) {\n      return false;\n    }\n  }\n\n  if (\n    wrappedLock &&\n    wrappedLock.script &&\n    typeof wrappedLock.argsLen === \"number\" &&\n    wrappedLock.argsLen >= 0\n  ) {\n    const length = wrappedLock.argsLen * 2 + 2;\n    const lockArgsLength = wrappedLock.script.args.length;\n    const minLength = Math.min(length, lockArgsLength);\n\n    const cellLock = cell.cellOutput.lock;\n    if (cellLock.args.length !== length) {\n      return false;\n    }\n    if (\n      !(\n        cellLock.codeHash === wrappedLock.script.codeHash &&\n        cellLock.hashType === wrappedLock.script.hashType &&\n        cellLock.args.slice(0, minLength) ===\n          wrappedLock.script.args.slice(0, minLength)\n      )\n    ) {\n      return false;\n    }\n  }\n\n  if (wrappedType && wrappedType === \"empty\" && cell.cellOutput.type) {\n    return false;\n  }\n  if (wrappedType && typeof wrappedType === \"object\") {\n    if (\n      !cell.cellOutput.type ||\n      !new ScriptValue(cell.cellOutput.type, {\n        validate: false,\n      }).equals(\n        new ScriptValue(wrappedType.script, {\n          validate: false,\n        })\n      )\n    ) {\n      return false;\n    }\n  }\n  if (data && data !== \"any\" && cell.data !== data) {\n    return false;\n  }\n  if (\n    fromBlock &&\n    cell.blockNumber &&\n    BI.from(cell.blockNumber).lt(BI.from(fromBlock))\n  ) {\n    return false;\n  }\n  if (\n    toBlock &&\n    cell.blockNumber &&\n    BI.from(cell.blockNumber).gt(BI.from(toBlock))\n  ) {\n    return false;\n  }\n\n  return true;\n}\n"],"mappings":"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"}