{"version":3,"file":"from_info.js","names":["CKBHasher","utils","serializeMultisigScript","R","M","publicKeyHashes","Error","toString","slice","length","map","h","join","multisigArgs","serializedMultisigScript","since","sinceLE","bytes","hexify","number","Uint64LE","pack","update","digestHex","parseFromInfo","fromInfo","config","undefined","getConfig","fromScript","multisigScript","destroyable","customData","parseAddress","template","SCRIPTS","SECP256K1_BLAKE160_MULTISIG","fromScriptArgs","codeHash","CODE_HASH","hashType","HASH_TYPE","args","ANYONE_CAN_PAY","address","script"],"sources":["../src/from_info.ts"],"sourcesContent":["import {\n  PackedSince,\n  Hash,\n  Address,\n  Script,\n  HexString,\n  utils,\n} from \"@ckb-lumos/base\";\nimport { Options, parseAddress } from \"@ckb-lumos/helpers\";\nimport { getConfig } from \"@ckb-lumos/config-manager\";\nimport { bytes, number } from \"@ckb-lumos/codec\";\n\nconst { CKBHasher } = utils;\n\n/**\n * secp256k1_blake160_multisig script requires S, R, M, N and public key hashes\n * S must be zero now\n * and N equals to publicKeyHashes size\n * so only need to provide R, M and public key hashes\n */\nexport interface MultisigScript {\n  /** first nth public keys must match, 1 byte */\n  R: number;\n  /** threshold, 1 byte */\n  M: number;\n  /** blake160 hashes of compressed public keys */\n  publicKeyHashes: Hash[];\n  /** locktime in since format */\n  since?: PackedSince;\n}\n\nexport interface ACP {\n  address: Address;\n  destroyable?: boolean; // default to false\n}\n\nexport interface CustomScript {\n  script: Script;\n  customData: HexString;\n}\n\nexport type FromInfo = MultisigScript | Address | ACP | CustomScript;\n\n/**\n *\n * @param params multisig script params\n * @returns serialized multisig script\n */\nexport function serializeMultisigScript({\n  R,\n  M,\n  publicKeyHashes,\n}: MultisigScript): HexString {\n  if (R < 0 || R > 255) {\n    throw new Error(\"`R` should be less than 256!\");\n  }\n  if (M < 0 || M > 255) {\n    throw new Error(\"`M` should be less than 256!\");\n  }\n  // TODO: validate publicKeyHashes\n  return (\n    \"0x00\" +\n    (\"00\" + R.toString(16)).slice(-2) +\n    (\"00\" + M.toString(16)).slice(-2) +\n    (\"00\" + publicKeyHashes.length.toString(16)).slice(-2) +\n    publicKeyHashes.map((h) => h.slice(2)).join(\"\")\n  );\n}\n\n/**\n *\n * @param serializedMultisigScript\n * @param since\n * @returns lock script args\n */\nexport function multisigArgs(\n  serializedMultisigScript: HexString,\n  since?: PackedSince\n): HexString {\n  let sinceLE = \"0x\";\n  if (since != null) {\n    sinceLE = bytes.hexify(number.Uint64LE.pack(since));\n  }\n  return (\n    new CKBHasher().update(serializedMultisigScript).digestHex().slice(0, 42) +\n    sinceLE.slice(2)\n  );\n}\n\nexport function parseFromInfo(\n  fromInfo: FromInfo,\n  { config = undefined }: Options = {}\n): {\n  fromScript: Script;\n  multisigScript?: HexString;\n  destroyable?: boolean;\n  customData?: HexString;\n} {\n  config = config || getConfig();\n\n  let fromScript: Script | undefined;\n  let multisigScript: HexString | undefined;\n  let destroyable: boolean | undefined;\n  let customData: HexString | undefined;\n\n  if (typeof fromInfo === \"string\") {\n    // fromInfo is an address\n    fromScript = parseAddress(fromInfo, { config });\n  } else {\n    if (\"R\" in fromInfo) {\n      const template = config.SCRIPTS.SECP256K1_BLAKE160_MULTISIG;\n      if (!template) {\n        throw new Error(\n          \"Provided config does not have SECP256K1_BLAKE16_MULTISIG script setup!\"\n        );\n      }\n\n      multisigScript = serializeMultisigScript(fromInfo);\n      const fromScriptArgs = multisigArgs(multisigScript, fromInfo.since);\n      fromScript = {\n        codeHash: template.CODE_HASH,\n        hashType: template.HASH_TYPE,\n        args: fromScriptArgs,\n      };\n    } else if (\"address\" in fromInfo) {\n      const template = config.SCRIPTS.ANYONE_CAN_PAY;\n      if (!template) {\n        throw new Error(\n          \"Provided config does not have ANYONE_CAN_PAY script setup!\"\n        );\n      }\n\n      const address = fromInfo.address;\n      fromScript = parseAddress(address, { config });\n      destroyable = fromInfo.destroyable;\n\n      if (\n        fromScript.codeHash !== template.CODE_HASH ||\n        fromScript.hashType !== template.HASH_TYPE\n      ) {\n        throw new Error(`fromInfo.address is not ANYONE_CAN_PAY address!`);\n      }\n    } else if (\"script\" in fromInfo) {\n      fromScript = fromInfo.script;\n      customData = fromInfo.customData;\n    } else {\n      throw new Error(\"Invalid fromInfo format!\");\n    }\n  }\n\n  return {\n    fromScript,\n    multisigScript,\n    destroyable,\n    customData,\n  };\n}\n"],"mappings":"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"}