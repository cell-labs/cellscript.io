{"version":3,"file":"p2pkh.js","names":["groupInputs","inputs","locks","lockSet","Set","lock","scriptHash","utils","ckbHash","blockchain","Script","pack","add","groups","Map","i","length","cellOutput","has","get","undefined","set","push","calcRawTxHash","tx","createdTx","createTransactionFromSkeleton","rawTx","cellDeps","headerDeps","outputs","outputsData","version","RawTransaction","defaultCkbHasher","hasher","CKBHasher","update","message","buffer","digest","bytes","bytify","digestHex","resolveThunk","thunkOrValue","Function","createP2PKHMessageGroup","thunkableHasher","toArray","rawTxHash","Error","messageGroup","group","keys","messageHasher","indexes","firstIndex","firstWitness","witnesses","lengthBuffer","ArrayBuffer","view","DataView","witnessHexString","BI","from","toString","setUint32","Number","slice","Uint8Array","witness","digested","g","index","Array","prototype","map","call","x","join"],"sources":["../src/p2pkh.ts"],"sourcesContent":["import {\n  Cell,\n  utils,\n  Hash,\n  Script,\n  HexString,\n  RawTransaction,\n  blockchain,\n} from \"@ckb-lumos/base\";\nimport {\n  TransactionSkeletonType,\n  createTransactionFromSkeleton,\n} from \"@ckb-lumos/helpers\";\nimport { bytes } from \"@ckb-lumos/codec\";\nimport { BI } from \"@ckb-lumos/bi\";\n\nfunction groupInputs(inputs: Cell[], locks: Script[]): Map<string, number[]> {\n  const lockSet = new Set<string>();\n  for (const lock of locks) {\n    const scriptHash = utils.ckbHash(blockchain.Script.pack(lock));\n    lockSet.add(scriptHash);\n  }\n\n  const groups = new Map<string, number[]>();\n  for (let i = 0; i < inputs.length; i++) {\n    const scriptHash = utils.ckbHash(\n      blockchain.Script.pack(inputs[i].cellOutput.lock)\n    );\n    if (lockSet.has(scriptHash)) {\n      if (groups.get(scriptHash) === undefined) groups.set(scriptHash, []);\n      groups.get(scriptHash)!.push(i);\n    }\n  }\n  return groups;\n}\n\nfunction calcRawTxHash(tx: TransactionSkeletonType): HexString {\n  const createdTx = createTransactionFromSkeleton(tx);\n  const rawTx: RawTransaction = {\n    cellDeps: createdTx.cellDeps,\n    headerDeps: createdTx.headerDeps,\n    inputs: createdTx.inputs,\n    outputs: createdTx.outputs,\n    outputsData: createdTx.outputsData,\n    version: createdTx.version,\n  };\n  return utils.ckbHash(blockchain.RawTransaction.pack(rawTx));\n}\n\nexport interface Hasher {\n  update(message: Uint8Array): void;\n  digest(): Uint8Array;\n}\n\ntype Group = {\n  index: number;\n  lock: Script;\n  message: Hash;\n};\n\ntype ThunkOrValue<T> = T | (() => T);\n\ninterface Options {\n  hasher?: ThunkOrValue<Hasher>;\n}\n\nconst defaultCkbHasher: ThunkOrValue<Hasher> = () => {\n  const hasher = new utils.CKBHasher();\n  return {\n    update: (message) => hasher.update(message.buffer),\n    digest: () => bytes.bytify(hasher.digestHex()),\n  };\n};\n\nfunction resolveThunk<T>(thunkOrValue: ThunkOrValue<T>): T {\n  if (thunkOrValue instanceof Function) return thunkOrValue();\n  return thunkOrValue;\n}\n\n/**\n * Return an array of messages as well as their corresponding position indexes and locks for signing a P2PKH transaction.\n * For more details, please see:\n * https://github.com/nervosnetwork/ckb-system-scripts/wiki/How-to-sign-transaction\n *\n * @param tx TxSkeleton with all input cells' witnessArgs.lock filled with 0.\n * @param locks Locks you want to sign, e.g. you don't need to sign ACP cells.\n * @param hasher Message hasher, defaults to CKB blake2b hasher. Check\n * https://github.com/nervosnetwork/ckb-system-scripts/blob/e975e8b7d5231fdb1c537b830dd934b305492417/c/secp256k1_blake160_sighash_all.c#L22-L28 for more.\n * @returns An array of Group containing: lock of the input cell you need to sign, message for signing, witness index of this message (first index of the input cell with this lock).\n */\nexport function createP2PKHMessageGroup(\n  tx: TransactionSkeletonType,\n  locks: Script[],\n  { hasher: thunkableHasher = defaultCkbHasher }: Options = {}\n): Group[] {\n  const groups = groupInputs(tx.inputs.toArray(), locks);\n  const rawTxHash = calcRawTxHash(tx);\n\n  if (locks.length > 1 && !(thunkableHasher instanceof Function)) {\n    // If we have multiple locks to group, we need the hasher to be thunk so that in the second group we can get another new hasher.\n    throw new Error(\n      \"Must provide hasher producer when you have multiple locks to group.\"\n    );\n  }\n\n  const messageGroup: Group[] = [];\n\n  for (const group of groups.keys()) {\n    const messageHasher = resolveThunk(thunkableHasher);\n    const indexes = groups.get(group)!;\n    const firstIndex = indexes[0];\n    const firstWitness = tx.witnesses.get(firstIndex);\n    if (firstWitness === undefined) {\n      throw new Error(\"Please fill witnesses with 0 first!\");\n    }\n    messageHasher.update(bytes.bytify(rawTxHash));\n\n    const lengthBuffer = new ArrayBuffer(8);\n    const view = new DataView(lengthBuffer);\n    const witnessHexString = BI.from(\n      bytes.bytify(firstWitness).length\n    ).toString(16);\n    if (witnessHexString.length <= 8) {\n      view.setUint32(0, Number(\"0x\" + witnessHexString), true);\n      view.setUint32(4, Number(\"0x\" + \"00000000\"), true);\n    }\n\n    if (witnessHexString.length > 8 && witnessHexString.length <= 16) {\n      view.setUint32(0, Number(\"0x\" + witnessHexString.slice(-8)), true);\n      view.setUint32(4, Number(\"0x\" + witnessHexString.slice(0, -8)), true);\n    }\n\n    messageHasher.update(new Uint8Array(lengthBuffer));\n    messageHasher.update(bytes.bytify(firstWitness));\n\n    for (let i = 1; i < indexes.length; i++) {\n      const witness = tx.witnesses.get(indexes[i])!;\n      messageHasher.update(new Uint8Array(lengthBuffer));\n      messageHasher.update(bytes.bytify(witness));\n    }\n\n    for (\n      let i = tx.inputs.toArray().length;\n      i < tx.witnesses.toArray().length;\n      i++\n    ) {\n      const witness = tx.witnesses.get(i)!;\n      messageHasher.update(new Uint8Array(lengthBuffer));\n      messageHasher.update(bytes.bytify(witness));\n    }\n\n    const digested = messageHasher.digest();\n    const g: Group = {\n      index: firstIndex,\n      lock: tx.inputs.get(firstIndex)!.cellOutput.lock,\n      message:\n        \"0x\" +\n        Array.prototype.map\n          .call(digested, (x) => (\"00\" + x.toString(16)).slice(-2))\n          .join(\"\"),\n    };\n\n    messageGroup.push(g);\n  }\n\n  return messageGroup;\n}\n"],"mappings":"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"}